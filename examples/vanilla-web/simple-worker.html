<!DOCTYPE html>
<html lang="en">
  <!--
  -- @file    dcp-worker.html - Sample web page showing how to implement a
  --                            trivial DCP worker.
  --
  -- @author  Wes Garland <wes@distributive.network>
  -- @author  Bryan Hoang <bryan@distributive.network>
  -- @date    Aug. 2019, Sept. 2022
  -->
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="http://scheduler.david.office.distributive.network/dcp-client/dcp-client.js"></script>
    <script type="module">
      const {
        wallet,
        worker: { Worker: DCPWorker },
      } = window.dcp;

      // The maximum number of sandboxes to have working in parallel.
      const defaultMaxSliceCount = 1;

      // What bank account the worker will send its earned funds to.
      const paymentAddress = (await wallet.get()).address;

      // What identity the worker will use to communicate to the scheduler.
      const identity = await wallet.getId();

      const options = {
        paymentAddress: (await wallet.get()).address,
        maxWorkingSandboxes: 1,
        computeGroups: [],
        leavePublicGroup: false,
        // Make sure the worker is only allowed to work on the job addresses that we specify
      };
      
      const worker = new DCPWorker(identity,
        options);

      // Attaching event listeners to see what's going on.
      worker.on('start', () => {
        console.log('Worker started working!');
      });

      worker.on('sandbox', (sandbox) => {
        sandbox.on('ready', (event) => {
          console.log('sandbox ready', event);
        });
        job.on('readystatechange', (ev) => {
          if (ev === 'deployed')
          {
            worker.workerOptions.jobAddresses = [job.address];
            worker.start();
          }
        })

        sandbox.on('start', ({ sandbox, job }) => {
          const { name = '', description = '', link = '' } = job;
          console.log(
            `Sandbox ${sandbox.id} started slice for job with`,
            `Name: "${name}",`,
            `Description: "${description}", and`,
            `Link: "${link}"`,
          );
        });

        sandbox.on('progress', (event) => {
          console.log(`Sandbox ${sandbox.id} progress`, event);
        });

        const sandboxEmit = sandbox.emit.bind(sandbox);
      });

      worker.on('payment', ({ accepted, payment }) => {
        if (accepted) {
          console.log(`You earned ${payment} DCC!`);
        } else {
          console.log('the result you computed was not accepted.');
        }
      });

      // Starting the worker.
      await worker.start();
    </script>
  </head>
  <body>
    This is a minimal vanilla web DCP Worker example. Look in your browser's
    console for output.
  </body>
</html>
