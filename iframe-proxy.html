<!DOCTYPE html>
<html lang="en-CA">
  <head><meta charset="utf-8">
<!-- 
  -- @file      iframe-proxy.html       A client-side proxy for local content; used
  --                                    to work around CORS-limitations, especially 
  --                                    on platforms where the web server cannot be
  --                                    configured to send permissive CORS headers
  --                                    for static content.
  --
  -- @author    KC Erb, kcerb@kingsds.network
  -- @date      Mar 2020
  -->
<!--  Instructions:
  --    Set this html as the src of an iframe in order to
  -- load files relative to it without triggering cross-origin
  -- checks. The `src` property must include the `relative-url`
  -- param in order for this proxy to fetch anything.
  --
  --  Example src: //mycdn.kittens.org/iframe-proxy.html?relative-url=.%2Fpath%2Fto%2Fresource.js
  --
  --  Note that relative paths must start with a ./ (where %2F is slash).
  --
  -- This particular implementation of the iframe-proxy pattern also supports
  -- a `lang` query parameter which may be provided by `navigator.language`. It
  -- will attempt to find a translation in the request language and fallback to
  -- english for any unknown keys.
 -->
  <script>
  async function go() {
    const params = new URLSearchParams(window.location.search);

    // relative-url
    const relativePath = params.get("relative-url");
    if (relativePath.indexOf("./") !== 0)
      throw new Error(`Relative path for iframe proxy must start with './', got: "${relativePath}"`);

    // lang
    const langCode = params.get("lang").slice(0,2);
    const rawContent = await (await fetch(relativePath)).text();
    const english = await (await fetch(`./i18n/en.json`)).json();

    let otherLang;
    if (langCode !== 'en') {
      try {
        otherLang = await (await fetch(`./i18n/${langCode}.json`)).json();
      } catch (error) {
        otherLang = {};
      }
    }
    // Fall back to english
    const translations = {...english, ...otherLang};

    // sub out {{}} contents
    const content = rawContent.replace(/{{[^}]*}}/g, (match) => translations[match.slice(2,-2)]);
    window.parent.postMessage(content, '*');
  }
  </script></head>
  <body onload="go();"></body>
</html>
