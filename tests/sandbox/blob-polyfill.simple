#! /usr/bin/env node
/** 
 * @file       blob-polyfill.simple
 * 
 * Test that the Blob Polyfill is working correctly and therefore can create an instance of the Blob class.
 * 
 * @author     Ryan Saweczko <ryansaweczko@distributive.network>
 * @author     Brandon Christie <brandon@distributive.network>
 * 
 * @date       December 2022
 */


process.exitCode = 1;

const sandboxScripts = '../../libexec/sandbox/';

const files = [
  require.resolve(sandboxScripts + 'script-load-wrapper.js'),
  require.resolve(sandboxScripts + 'access-lists.js'),
];

const expectedOutputs = {
  'script-load-wrapper': false,
  'access-lists' : false,
};

function outputTests(message)
{
  if (message.value.script === 'script-load-wrapper')
    expectedOutputs['script-load-wrapper'] = true;
  if (message.value.script === 'access-lists')
    expectedOutputs['access-lists'] = true;
  // If all of my expected outputs have been met, set the exit code to 0 since all was ok.
  if (Object.values(expectedOutputs).every((ele) =>  ele))
    process.exitCode = 0;
}

require('./globalPolyfillHelper').init(files, outputTests);

async function blobTests(blob)
{
  console.log('Blob.arrayBuffer() - ', await blob.arrayBuffer());
  console.log('Blob.slice() - ', blob.slice());
  try
  {
    console.log('Blob.stream() - ', blob.stream());
  }
  catch (error)
  {
    // if Blob.stream() is NYI, then it will throw a TypeError that we can
    // semi-quietly ignore; anything else should be rethrown.
    if (!error instanceof TypeError)
      throw error;
    console.warn('Blob.stream() - NYI', error);
  }
  console.log('Blob.text() - ', await blob.text());
  console.log('Blob.size', blob.size);
  console.log('Blob.type', blob.type);
}

let blob = new Blob([JSON.stringify({ type: 'Testing' })], { type: 'application/json' });

blobTests(blob);

// Give more information in the event the test fails.
process.on('exit',function test(code) {
  if (code !== 0)
    console.error(`Test Failed. End values for expected outputs was ${JSON.stringify(expectedOutputs)}`);
});
