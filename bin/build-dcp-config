#!/usr/bin/env node
/* eslint-disable node/shebang */
/**
 * @file        download        Program to create dcpConfig variable based on dcp-client::init()
 *                              semantics, and dump the serialized version of it over fd 3.
 *
 * @author      Wes Garland, wes@kingsds.netework
 * @date        Aug 2020
 */
const fs = require('fs');

const dcpClient = require('..');
const assert  = require('assert');
const { Address } = require('dcp/wallet');
const kvin = require('dcp/internal/kvin');

let outputFd = +(process.env.BUILD_DCP_CONFIG_OUTPUT_FD || "3");

async function main() {
  const custom = dcpClient.__KVIN;
  assert(custom.userCtors.dcpEth$$Address);
  assert(custom.userCtors.dcpUrl$$DcpURL);

  dcpClient._initHead();

  const input = fs.readFileSync(process.stdin.fd, 'utf-8');
  const { initConfig, options } = custom.deserialize(input);
  const outputObjects = await dcpClient.createConfigFragments(initConfig, options);
  delete outputObjects.internalConfig;
  const output = await custom.serializeAsync(outputObjects);
  
  try {
    fs.writeSync(outputFd, output, 'utf-8');
  } catch(e) {
    if (e.code === 'EINVAL') {
      console.warn(`Warning: fd ${outputFd} invalid; writing to stdout instead`);
      fs.writeSync(process.stdout.fd, output, 'utf-8');
    } else {
      throw e;
    }
  }
}

main()
  .catch(console.error)
  .finally(() => setImmediate(process.exit));
